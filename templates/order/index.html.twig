{% extends 'base.html.twig' %}

{% block title %}Checkout{% endblock %}

{% block body %}
<div class="container my-5">
    <div class="row">
        <!-- Formulaire -->
        <div class="col-md-8">
            <div class="card shadow-sm p-4">
                <h2 class="mb-4">Informations de livraison</h2>

                {{ form_start(form) }}
                    <div class="row g-3">
                        {{ form_widget(form) }}
                    </div>

                    <div class="mt-4 text-end">
                        <button type="submit" class="btn btn-primary">
                            Continuer
                        </button>
                    </div>
                {{ form_end(form) }}
            </div>
        </div>

        <!-- Résumé commande -->
        <div class="col-md-4">
            <div class="card shadow-sm p-4">
                <h4 class="mb-3">Résumé</h4>

                <div class="d-flex justify-content-between mb-2">
                    <span>Produits</span>
                    <strong id="product-total">{{ total }} €</strong>
                </div>

                <div class="d-flex justify-content-between mb-2">
                    <span>Frais de livraison</span>
                    <span id="shipping-cost" class="text-muted">--</span>
                </div>

                <hr>

                <div class="d-flex justify-content-between fs-5">
                    <span>Total à payer</span>
                    <strong id="grand-total">{{ total }} €</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js" 
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" 
        crossorigin="anonymous"></script>

<script>
    $(document).ready(function() {
        const citySelector = $('#order_city');
        const productTotal = parseFloat("{{ total }}"); // total des produits

        // Fonction pour calculer et afficher les frais de livraison
        function updateShipping(cityValue) {
            const url = `http://localhost:8000/city/${cityValue}/shipping/cost`;

            $.ajax({
                url: url,
                type: 'GET',
                success: function(response) {
                    const newResponse = JSON.parse(response);

                    if (parseInt(newResponse.status) === 200) {
                        const shippingCost = parseFloat(newResponse.content);

                        // Affichage frais de livraison
                        $('#shipping-cost').text(`${shippingCost.toFixed(2)} €`);

                        // Mise à jour du total final
                        const grandTotal = productTotal + shippingCost;
                        $('#grand-total').text(`${grandTotal.toFixed(2)}git push €`);
                    }
                },
                error: function() {
                    $('#shipping-cost').text('Erreur...');
                }
            });
        }

        // Charger au démarrage (ville par défaut)
        updateShipping(citySelector.val());

        // Quand on change de ville
        citySelector.on('change', function() {
            updateShipping($(this).val());
        });
    });
</script>
{% endblock %}
